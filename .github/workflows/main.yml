
	
	pipeline {
    agent any

    environment {
        
        Bugdazz = credentials('API_SC_TOKEN')
        REPO_URL       = "https://${Bugdazz}@github.com/Viraj2405/Hemangini"
        BRANCH     = 'main'
        FILE_NAME      = 'OneProvider Public Collection.postman_collection.json'
        TEMP_DIR       = 'temp-repo'
        SECURITY_SCAN_API = 'https://9c7bc9d8ca3d.ngrok-free.app/v1/startSecurityScan'
        PROJECT_ID     = '87925b6e-7863-4ac0-9fba-8519cbad64c5'
        BLOCK_PIPELINE = 'true'
        BLOCK_CRITICAL = 'true'
        BLOCK_HIGH     = 'true'
        BLOCK_MEDIUM   = 'true'
        CRITICAL_THRESHOLD = 0
        HIGH_THRESHOLD     = 0
        MEDIUM_THRESHOLD   = 0
        APPKEYTOKEN        = 'b115f598-a123-4b36-9d2a-c239c810884e'
        UPLOAD_API_URL = 'https://9c7bc9d8ca3d.ngrok-free.app/v1/webHook'
    }

		stages {
			stage('Clone & Upload File') {
				steps {
					script {
						bat """
						git clone --branch %BRANCH% --depth 1 "%REPO_URL%" %TEMP_DIR%
						for /f "delims=" %%F in ('dir /s /b "%TEMP_DIR%\\%FILE_NAME%"') do (
							echo Found: %%F
							copy "%%F" "%WORKSPACE%\\%FILE_NAME%"
						)
						rmdir /s /q %TEMP_DIR%
						"""

						if (fileExists("${env.FILE_NAME}")) {
							echo "File '${env.FILE_NAME}' found. Uploading..."
							bat """
							curl --location "%UPLOAD_API_URL%" ^
							--form "file=@%FILE_NAME%" ^
							--form "project_id=%PROJECT_ID%"
							"""
						} else {
							echo "File '${env.FILE_NAME}' not found. Skipping upload."
						}
					}
				}
			}
		

        stage('Run Security Scan') {
            steps {
                script {
                    def response = bat(
                        script: """
                        curl --silent --request POST "%SECURITY_SCAN_API%/%PROJECT_ID%" ^
                        --header "Api-Key: %APPKEYTOKEN%" ^
						--header "Content-Type: application/json" ^
                		--header "Content-Length: 0"
                        """,
                        returnStdout: true
                    ).trim()

                    echo "Scan Response: ${response}"

                    if (response.contains('"message":"token expired"')) {
                        error "Token expired. Aborting pipeline."
                    }

                    def jsonLine = response.readLines().find { it.trim().startsWith('{') }
					def json = new groovy.json.JsonSlurper().parseText(jsonLine)

					def critical = json.criticalCount ?: 0
					def high     = json.highCount ?: 0
					def medium   = json.mediumCount ?: 0

                    echo "Critical: ${critical}, High: ${high}, Medium: ${medium}"

                    if (env.BLOCK_PIPELINE == 'true') {
                        if (env.BLOCK_CRITICAL == 'true' && critical > (env.CRITICAL_THRESHOLD ?: '0').toInteger()) {
                            error "Blocked: Critical findings exceed threshold."
                        }
                        if (env.BLOCK_HIGH == 'true' && high > (env.HIGH_THRESHOLD ?: '0').toInteger()) {
                            error "Blocked: High findings exceed threshold."
                        }
                        if (env.BLOCK_MEDIUM == 'true' && medium > (env.MEDIUM_THRESHOLD ?: '0').toInteger()) {
                            error "Blocked: Medium findings exceed threshold."
                        }
                        echo "No blocking issues. Continuing pipeline."
                    } else {
                        echo "Blocking is disabled."
                    }
                }
            }
        }

        stage('Post-processing') {
            steps {
                echo "Post-processing complete."
            }
        }
    }
	
    post {
        always {
            cleanWs()
        }
    }
}
	
